# AGENTS.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Project Overview

DevProxy is a local reverse proxy with web UI for Docker Compose projects. It automatically manages routing custom domains to Docker containers and optionally syncs routes to the system hosts file via an agent.

**Tech Stack:**
- **Caddy** — Reverse proxy with automatic reload via API
- **Go (Gin)** — API backend (backend/)
- **Vue.js 3** — Web UI (backend/frontend/)
- **SQLite** — Route storage
- **Host Agent** — Cross-platform hosts file manager (agent/)

**Ports:**
- 80: Caddy reverse proxy
- 8090: DevProxy Web UI
- 9099: Host Agent config UI (when agent is running)

## Architecture

### Multi-Stage Build Process
The project uses a multi-stage Docker build (backend/Dockerfile) that:
1. Builds the Vue.js frontend and embeds it into the Go binary using `//go:embed`
2. Cross-compiles the Host Agent for Windows and Linux (stored in container for user download)
3. Builds the Go API backend with CGO enabled for SQLite support

### Backend Structure (backend/)
- **main.go** — Entry point; initializes DB, Caddy service, health checker, and serves embedded frontend
- **internal/database/** — SQLite operations (routes CRUD)
- **internal/services/** — Business logic:
  - `caddy.go`: Generates Caddyfile from enabled routes, reloads Caddy via HTTP API (port 2019)
  - `health.go`: Background health checker for upstream containers
- **internal/handlers/** — Gin HTTP handlers for API endpoints
- **internal/models/** — Data structures

### Host Agent Structure (agent/)
Standalone Go application that runs on the host machine to automatically sync DevProxy routes to the system hosts file.
- **main.go** — Entry point; starts sync engine, GUI server, and system tray (Windows)
- **sync/sync.go** — Polls DevProxy API every 5 seconds, writes enabled routes to hosts file
- **hosts/** — Cross-platform hosts file manipulation with backups
- **config/** — Configuration management
- **gui/** — Local web UI for agent configuration (port 9099)
- **tray/** — System tray icon (Windows only, tray_windows.go vs tray_other.go)
- **autostart/** — Platform-specific autostart functionality

### Data Flow
1. User adds routes via Web UI → API stores in SQLite
2. API generates Caddyfile from enabled routes → Reloads Caddy via HTTP API
3. Host Agent (optional) fetches routes from API → Updates hosts file with backups

## Development Commands

### Main Project
```bash
# Start DevProxy (builds all components)
docker compose up -d --build

# View logs
docker compose logs -f api
docker compose logs -f caddy

# Restart services
docker compose restart

# Stop and remove
docker compose down

# Rebuild after code changes
docker compose up -d --build
```

### Backend Development (Go)
```bash
# From backend/ directory
cd backend

# Run locally (requires Go 1.22+)
go run main.go

# Build locally
go build -o devproxy-api

# Run tests
go test ./...

# Dependencies
go mod tidy
```

### Host Agent Development (Go)
```bash
# From agent/ directory
cd agent

# Run locally (requires admin/sudo for hosts file access)
# Windows:
go run . (Right-click IDE and run as administrator)

# Linux:
sudo go run .

# Build for current platform
go build -o devproxy-agent

# Cross-compile for Windows
CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-s -w -H=windowsgui" -o devproxy-agent.exe

# Cross-compile for Linux
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o devproxy-agent

# Run tests
go test ./...

# Dependencies
go mod tidy
```

### Frontend Development (Vue.js)
```bash
# From backend/frontend/ directory
cd backend/frontend

# Install dependencies
npm install

# Dev server with hot reload
npm run dev

# Build for production
npm run build

# Output goes to backend/frontend/dist/ (embedded by Go)
```

## Docker Network Setup

DevProxy requires the `dev-proxy` Docker network to route to other containers:

```bash
# Create network (one-time setup)
docker network create dev-proxy

# Connect your containers by adding to docker-compose.override.yaml:
services:
  your-service:
    networks:
      - dev-proxy
      - default

networks:
  default:
  dev-proxy:
    external: true
```

## Key Implementation Details

- **Caddyfile Generation**: Routes are dynamically generated by `services/caddy.go` from enabled routes in SQLite. Caddy is reloaded via its HTTP API at `:2019`.
- **Health Checks**: Background goroutine in `services/health.go` pings upstream targets to verify container availability.
- **Applied State**: The API tracks the last successfully applied Caddyfile configuration to detect pending changes in the UI.
- **Hosts File Sync**: The agent uses a marker system to identify its managed entries, creates timestamped backups before each write, and prunes old backups.
- **Embedded Frontend**: The Vue.js frontend is compiled and embedded into the Go binary using `//go:embed`, so the API serves a fully self-contained SPA.
