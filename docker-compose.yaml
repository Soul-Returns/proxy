services:
    # Caddy reverse proxy
    caddy:
        image: caddy:2-alpine
        restart: unless-stopped
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ./data/Caddyfile:/etc/caddy/Caddyfile:ro
            - caddy_data:/data
            - caddy_config:/config
        networks:
            - internal
            - dev-proxy
        depends_on:
            - api

    # Go API backend
    api:
        build:
            context: ./backend
            dockerfile: Dockerfile
        restart: unless-stopped
        ports:
            - "8090:8080"
        volumes:
            - ./data:/app/data
        environment:
            - DB_PATH=/app/data/devproxy.db
            - CADDYFILE_PATH=/app/data/Caddyfile
            - CADDY_API=http://caddy:2019
        networks:
            - internal
            - dev-proxy

volumes:
    caddy_data:
    caddy_config:

networks:
    internal:
    dev-proxy:
        external: true
